<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Grand Parish Register (c. 1588)</title>
    <link href="https://fonts.googleapis.com/css2?family=IM+Fell+English+SC&family=Uncial+Antiqua&display=swap" rel="stylesheet">
    <link href="./style.css" rel="stylesheet">
</head>
<body>

    <div id="content-sources" style="display:none;">
        
        <div id="source-1">
             <div class="manuscript-page-content">
                <div class="illuminated-border"></div>
                <!-- <header class="manuscript-header">
                     <div class="miniature miniature-gemini"></div>
                </header> -->
                <main class="manuscript-body" style="text-align: center; padding-top: 5rem;">
                     <h1 class="page-title" style="font-size: 2rem;">Liber Parochialis</h1>
                     <p class="drop-cap" style="font-size: 1.2rem;">A Register of Births, Marriages, and Burials, and other Notable Occurrences within the Parish of St. Jude's, commenced during the reign of Her Most Excellent Majesty, Queen Elizabeth, Anno Domini MDLXXXVIII.</p>
                </main>
                <!-- <footer class="manuscript-footer">
                    <div class="miniature"></div>
                </footer> -->
            </div>
        </div>

        <div id="source-2">
            <div class="manuscript-page-content">
                <div class="illuminated-border"></div>
                <header class="manuscript-header">
                     <h2 class="page-title">Mensids Maius</h2>
                </header>
                <main class="manuscript-body">
                    <table class="calendar-table">
                        <tbody>
                            <tr>
                                <td class="col-numeral"></td>
                                <td class="col-letter text-red">c</td>
                                <td class="col-feast text-red">Sancti Philippi & Iacobi</td>
                                <td class="col-abbr">m kl.</td>
                            </tr>
                             <tr>
                                <td class="col-numeral">VI</td>
                                <td class="col-letter">d</td>
                                <td class="col-feast text-blue">Sancti Athanasii epi & conf.</td>
                                <td class="col-abbr">III kl.</td>
                            </tr>
                             <tr>
                                <td class="col-numeral">V</td>
                                <td class="col-letter">e</td>
                                <td class="col-feast">Inuencio sancte crucis.</td>
                                <td class="col-abbr">III kl.</td>
                            </tr>
                            <tr><td colspan="4">&nbsp;</td></tr>
                             <tr>
                                <td class="col-numeral">II</td>
                                <td class="col-letter">a</td>
                                <td class="col-feast text-red">Sancti Iohis ante porta lat.</td>
                                <td class="col-abbr">m kl.</td>
                            </tr>
                            <tr><td colspan="4">&nbsp;</td></tr>
                            <tr>
                                <td class="col-numeral">VIII</td>
                                <td class="col-letter text-red">c</td>
                                <td class="col-feast">Sancti Nicholai.</td>
                                <td class="col-abbr">m kl.</td>
                            </tr>
                             <tr>
                                <td class="col-numeral">VII</td>
                                <td class="col-letter">d</td>
                                <td class="col-feast">Sancti Gordiani & Epimachi m.</td>
                                <td class="col-abbr">m kl.</td>
                            </tr>
                             <tr>
                                <td class="col-numeral">VI</td>
                                <td class="col-letter">e</td>
                                <td class="col-feast text-blue">Sancti Nerei, Achillei, & Pancracii</td>
                                <td class="col-abbr">III kl.</td>
                            </tr>
                        </tbody>
                    </table>
                </main>
                <!-- <footer class="manuscript-footer">
                     <div class="miniature miniature-cancer"></div>
                </footer> -->
            </div>
        </div>
        
        <div id="source-3">
             <div class="manuscript-page-content">
                <div class="illuminated-border"></div>
                <header class="manuscript-header">
                     <h2 class="page-title">Noteworthy Occurrences</h2>
                </header>
                <main class="manuscript-body">
                    <p class="drop-cap"><strong>July 8th:</strong> The tax collector, Mr. Hawthorne, arrived and demanded an increase in the King's levies.</p>
                    <p><strong>July 12th:</strong> A massive storm damaged the eastern wall of the church. Repairs commenced immediately.</p>
                    <p><strong>Aug 3rd:</strong> The butcher's apprentice, Young Will, was caught stealing loaves of bread. He was pardoned by the Vicar.</p>
                    <p><strong>Sept 1st:</strong> The annual harvest was bountiful, thanks be to God. A grand feast was held for all villagers.</p>
                </main>
                 <!-- <footer class="manuscript-footer">
                     <div class="miniature"></div>
                </footer> -->
            </div>
        </div>

        <div id="source-4">
             <div class="manuscript-page-content">
                <div class="illuminated-border"></div>
                <header class="manuscript-header">
                     <h2 class="page-title">Inventory of Goods</h2>
                </header>
                <main class="manuscript-body">
                     <p class="drop-cap"><strong>Parish Chest:</strong> One (1) locked oak chest. Contents sealed by the Bishop's authority.</p>
                    <p><strong>Book of Psalms:</strong> Bound in leather, worn but intact. Lacking the cover of the 1549 edition.</p>
                    <p><strong>Altar Cloth:</strong> Embroidered with gold thread, donated by the Ladies' Guild.</p>
                    <p><strong>Silver Crucifix:</strong> Missing a small decorative stone from the base.</p>
                </main>
                 <!-- <footer class="manuscript-footer">
                     <div class="miniature"></div>
                </footer> -->
            </div>
        </div>
    </div>


    <div id="book-element" class="book-container">
        <div id="static-left-page" class="page">
            <div id="display-left-content"></div>
            <div id="drag-target-left" class="drag-target-left"></div>
        </div>
        <div id="static-right-page" class="page">
            <div id="display-right-content"></div>
            <div id="drag-target-right" class="drag-target-right"></div>
        </div>

        <div id="page-flip">
            <div id="page-flip-front" class="flip-content"></div>
            <div id="page-flip-back" class="flip-content"></div>
        </div>

        <div id="status-message" class="absolute bottom-4 left-1/2 transform -translate-x-1/2 text-sm text-gray-400 font-sans">
            Grab the page edge to turn.
        </div>
    </div>

    <script>
        const bookElement = document.getElementById('book-element');
        const pageFlip = document.getElementById('page-flip');
        const dragTargetRight = document.getElementById('drag-target-right');
        const dragTargetLeft = document.getElementById('drag-target-left');
        const statusMessage = document.getElementById('status-message');
        const displayLeft = document.getElementById('display-left-content');
        const displayRight = document.getElementById('display-right-content');
        const flipFront = document.getElementById('page-flip-front');
        const flipBack = document.getElementById('page-flip-back');
        const sources = {
            1: document.getElementById('source-1').innerHTML,
            2: document.getElementById('source-2').innerHTML,
            3: document.getElementById('source-3').innerHTML,
            4: document.getElementById('source-4').innerHTML
        };
        const SNAP_DURATION = 400;
        let currentSpread = 1;
        let isDragging = false;
        let startX = 0;
        let dragDirection = null;
        let initialAngle = 0;
        let currentRotationAngle = 0;
        let pageRect = null;

        function getCoords(e) {
            if (e.touches && e.touches.length > 0) {
                return { x: e.touches[0].clientX, y: e.touches[0].clientY };
            }
            return { x: e.clientX, y: e.clientY };
        }

        function setupContent(spreadNum) {
            currentSpread = spreadNum;
            pageFlip.classList.remove('snap-transition');

            if (spreadNum === 1) {
                displayLeft.innerHTML = sources[1];
                displayRight.innerHTML = sources[4];
                flipFront.innerHTML = sources[2];
                flipBack.innerHTML = sources[3];
                pageFlip.style.transform = 'rotateY(0deg) translateZ(2px)';
                pageFlip.style.zIndex = 50;
                initialAngle = 0;
                currentRotationAngle = 0;
                dragTargetRight.style.display = 'block';
                dragTargetLeft.style.display = 'none';
            } else {
                displayLeft.innerHTML = sources[3];
                displayRight.innerHTML = sources[2];
                flipFront.innerHTML = sources[4];
                flipBack.innerHTML = sources[1];
                pageFlip.style.transform = 'rotateY(-180deg) translateZ(2px)';
                pageFlip.style.zIndex = 10;
                initialAngle = -180;
                currentRotationAngle = -180;
                dragTargetRight.style.display = 'none';
                dragTargetLeft.style.display = 'block';
            }
            statusMessage.textContent = 'Grab the page edge to turn.';
        }

        function handleDragStart(e, direction) {
            e.preventDefault(); 
            if (isDragging) return;

            if ((direction === 'next' && currentSpread === 1) || (direction === 'prev' && currentSpread === 2)) {
                isDragging = true;
                dragDirection = direction;
                pageFlip.classList.remove('snap-transition');
                const coords = getCoords(e);
                startX = coords.x;
                pageRect = pageFlip.getBoundingClientRect();
                pageFlip.style.zIndex = 50; 
                document.addEventListener('mousemove', handleDragMove);
                document.addEventListener('mouseup', handleDragEnd);
                document.addEventListener('touchmove', handleDragMove);
                document.addEventListener('touchend', handleDragEnd);
                statusMessage.textContent = 'Flipping page...';
            }
        }

        function handleDragMove(e) {
            if (!isDragging) return;
            e.preventDefault();

            const coords = getCoords(e);
            const deltaX = coords.x - startX;
            let newAngle = initialAngle;
            
            if (dragDirection === 'next') {
                const maxDrag = pageRect.width;
                let dragRatio = Math.min(0, Math.max(-1, deltaX / maxDrag)); 
                newAngle = initialAngle + (dragRatio * 180);
            } else if (dragDirection === 'prev') {
                const maxDrag = pageRect.width;
                let dragRatio = Math.max(0, Math.min(1, deltaX / maxDrag)); 
                newAngle = initialAngle + (dragRatio * 180);
            }
            pageFlip.style.transform = `rotateY(${newAngle}deg) translateZ(2px)`;
            currentRotationAngle = newAngle; 
        }

        function handleDragEnd() {
            if (!isDragging) return;
            isDragging = false;
            document.removeEventListener('mousemove', handleDragMove);
            document.removeEventListener('mouseup', handleDragEnd);
            document.removeEventListener('touchmove', handleDragMove);
            document.removeEventListener('touchend', handleDragEnd);
            pageFlip.classList.add('snap-transition');

            let finalAngle = initialAngle;
            let hasFlipped = false;

            if (dragDirection === 'next' && currentRotationAngle < -90) {
                finalAngle = -180;
                hasFlipped = true;
            } else if (dragDirection === 'prev' && currentRotationAngle > -90) { 
                finalAngle = 0;
                hasFlipped = true;
            }
            
            pageFlip.style.transform = `rotateY(${finalAngle}deg) translateZ(2px)`;
            currentRotationAngle = finalAngle;

            if (hasFlipped) {
                setTimeout(() => {
                    setupContent(dragDirection === 'next' ? 2 : 1);
                    statusMessage.textContent = 'Spread updated.';
                }, SNAP_DURATION);
            } else {
                statusMessage.textContent = 'Flipped back, not enough drag.';
            }

            setTimeout(() => {
                pageFlip.classList.remove('snap-transition');
            }, SNAP_DURATION + 50);
        }

        window.onload = function() {
            setupContent(1);
        }

        dragTargetRight.addEventListener('mousedown', (e) => handleDragStart(e, 'next'));
        dragTargetRight.addEventListener('touchstart', (e) => handleDragStart(e, 'next'));
        dragTargetLeft.addEventListener('mousedown', (e) => handleDragStart(e, 'prev'));
        dragTargetLeft.addEventListener('touchstart', (e) => handleDragStart(e, 'prev'));

        // Keyboard navigation: flip with ArrowRight (next) and ArrowLeft (prev)
        function canHandleKeyEvent() {
            const active = document.activeElement;
            if (!active) return true;
            const tag = active.tagName ? active.tagName.toLowerCase() : '';
            // Don't intercept keys when typing in form controls or contenteditable areas
            if (tag === 'input' || tag === 'textarea' || active.isContentEditable) return false;
            return true;
        }

        function animateFlip(finalAngle) {
            if (isDragging) return;
            pageFlip.classList.add('snap-transition');
            // raise the flip above other layers while animating
            pageFlip.style.zIndex = 50;
            pageFlip.style.transform = `rotateY(${finalAngle}deg) translateZ(2px)`;
            currentRotationAngle = finalAngle;
            // remove transition class after animation completes
            setTimeout(() => {
                pageFlip.classList.remove('snap-transition');
            }, SNAP_DURATION + 50);
        }

        function flipToNext() {
            if (isDragging || currentSpread !== 1) return;
            // animate to the flipped position then swap content
            animateFlip(-180);
            setTimeout(() => {
                setupContent(2);
                statusMessage.textContent = 'Spread updated.';
            }, SNAP_DURATION);
        }

        function flipToPrev() {
            if (isDragging || currentSpread !== 2) return;
            animateFlip(0);
            setTimeout(() => {
                setupContent(1);
                statusMessage.textContent = 'Spread updated.';
            }, SNAP_DURATION);
        }

        window.addEventListener('keydown', (e) => {
            if (!canHandleKeyEvent()) return;
            if (e.key === 'ArrowRight') {
                e.preventDefault();
                flipToNext();
            } else if (e.key === 'ArrowLeft') {
                e.preventDefault();
                flipToPrev();
            }
        });
    </script>
</body>
</html>